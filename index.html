<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>美股 8因子仪表板 — v1（VIX 1年百分位）</title>
<style>
:root{ --bg:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--grid:#d1d5db;
       --fused:#2563eb;--c1:#0ea5e9;--c2:#f97316;--c3:#059669;--c4:#a855f7;--c5:#ef4444;--c6:#14b8a6;--c7:#64748b;--c8:#d97706;
       --green-bg:#EAF7F0;--range-bg:#F6F7FB;--red-bg:#FDEAEA; }
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto}
.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:2}
.badge{padding:2px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700}
.status{color:#065f46;background:#d1fae5;border-color:#a7f3d0}.status.red{color:#991b1b;background:#fee2e2;border-color:#fecaca}.status.range{color:#334155;background:#e2e8f0;border-color:#cbd5e1}
.btns button{padding:4px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.btns button.active{background:#111827;color:#fff;border-color:#111827}
.canvas-box{position:relative;margin:12px;height:56vh;min-height:360px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
canvas{width:100%;height:100%;display:block;background:#fff}
.tooltip{position:fixed;pointer-events:none;background:#111827;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .12s;max-width:260px;box-shadow:0 8px 20px rgba(0,0,0,.15)}
.legend{font-size:12px;color:#374151;display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:0 12px 8px}

/* 新的现代化时间范围滑块样式 */
.time-range-container{margin:16px 0;padding:0 4px}
.time-range-slider{position:relative;height:50px;margin:24px 0;cursor:pointer;will-change:transform}

/* 轨道背景 - 使用渐变和阴影 */
.time-track{
  position:absolute;
  top:22px;
  left:0;
  right:0;
  height:6px;
  background:linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
  border-radius:6px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.06);
}

/* 选中范围 - 透明蓝色玻璃质感 */
.time-selection{
  position:absolute;
  top:22px;
  height:6px;
  background:linear-gradient(90deg, rgba(59,130,246,0.8) 0%, rgba(37,99,235,0.9) 50%, rgba(59,130,246,0.8) 100%);
  border-radius:6px;
  transition:all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 2px 8px rgba(59,130,246,0.3), inset 0 1px 0 rgba(255,255,255,0.2);
  backdrop-filter:blur(8px);
}

/* 手柄 - 玻璃质感设计 */
.time-handle{
  position:absolute;
  top:14px;
  width:22px;
  height:22px;
  background:linear-gradient(145deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
  border:2px solid rgba(59,130,246,0.6);
  border-radius:50%;
  cursor:grab;
  transition:all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 4px 12px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.8);
  backdrop-filter:blur(10px);
  will-change:transform;
}

.time-handle:hover{
  transform:scale(1.15);
  box-shadow:0 6px 20px rgba(59,130,246,0.4), inset 0 1px 0 rgba(255,255,255,0.9);
  border-color:rgba(59,130,246,0.8);
}

.time-handle:active{
  cursor:grabbing;
  transform:scale(1.2);
  box-shadow:0 8px 25px rgba(59,130,246,0.5), inset 0 1px 0 rgba(255,255,255,1);
}

/* 起始和结束手柄的不同颜色 */
.time-handle-start{
  background:linear-gradient(145deg, rgba(16,185,129,0.9), rgba(5,150,105,0.8));
  border-color:rgba(16,185,129,0.7);
}

.time-handle-start:hover{
  border-color:rgba(16,185,129,0.9);
  box-shadow:0 6px 20px rgba(16,185,129,0.4), inset 0 1px 0 rgba(255,255,255,0.9);
}

.time-handle-end{
  background:linear-gradient(145deg, rgba(239,68,68,0.9), rgba(220,38,38,0.8));
  border-color:rgba(239,68,68,0.7);
}

.time-handle-end:hover{
  border-color:rgba(239,68,68,0.9);
  box-shadow:0 6px 20px rgba(239,68,68,0.4), inset 0 1px 0 rgba(255,255,255,0.9);
}

/* 拖拽状态优化 */
.time-range-slider.dragging{
  user-select:none;
}

.time-range-slider.dragging *{
  pointer-events:none;
}

.time-range-slider.dragging .time-handle{
  transition:none;
}

/* 时间标签美化 */
.time-labels{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color:#64748b;
  margin-top:12px;
  font-weight:500;
}

.time-labels .time-label{
  text-align:center;
  min-width:50px;
  padding:2px 6px;
  background:rgba(248,250,252,0.8);
  border-radius:4px;
  backdrop-filter:blur(4px);
}

.range-info{
  text-align:center;
  margin-top:12px;
  font-size:13px;
  color:#374151;
  font-weight:600;
  padding:8px 16px;
  background:linear-gradient(135deg, rgba(255,255,255,0.8), rgba(248,250,252,0.9));
  border-radius:8px;
  backdrop-filter:blur(8px);
  border:1px solid rgba(226,232,240,0.5);
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
}

fieldset{border:1px dashed var(--border);padding:6px 10px;border-radius:10px;margin:8px 12px}
legend{padding:0 6px;color:#374151}
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th,.tbl td{border:1px solid var(--border);padding:6px 8px;text-align:center}
.tbl input[type=number]{width:80px}
.src{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.src input[type=url]{width:460px;max-width:70vw;padding:6px 8px;border:1px solid var(--border);border-radius:8px}
.src button{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.note{color:#64748b;font-size:12px;margin-left:8px}
.err{color:#991b1b}.ok{color:#047857}

.presets{display:flex;align-items:center;justify-content:center;gap:10px;margin:6px 0 10px}
.presets .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.presets .seg .segbtn{padding:6px 12px;background:#fff;border:0;border-right:1px solid var(--border);cursor:pointer}
.presets .seg .segbtn:last-child{border-right:0}
.presets .seg .segbtn.active{background:#111827;color:#fff}

/* 隐藏权重配置区域 */
.weight-config{display:none}

/* 响应式调整 */
@media (max-width: 768px) {
  .toolbar{flex-direction:column;align-items:stretch}
  .time-range-container{margin:12px 0;padding:0 2px}
  .time-labels{font-size:10px}
  .range-info{font-size:12px;padding:6px 12px}
  .src{margin-top:12px;justify-content:center}
  .src input[type=url]{width:100%;max-width:none}
  .time-handle{width:20px;height:20px;top:15px}
}

/* 性能优化 */
.time-range-slider, .time-handle, .time-selection {
  transform:translateZ(0);
  backface-visibility:hidden;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div id="stateBadge" class="badge status">市场状态：—</div>
    <div class="btns">
      <button data-win="365">1年</button>
      <button data-win="180">6个月</button>
      <button data-win="90" class="active">3个月</button>
      <button data-win="30">1个月</button>
      <button data-win="0" id="btnAll">全部</button>
    </div>
  </div>

  <fieldset>
    <legend>阈值与显示设置</legend>
    <label>多头区 ≥ <input id="thrG" type="number" step="0.01" value="0.5" style="width:70px"></label>
    <label style="margin-left:8px">空头区 ≤ <input id="thrR" type="number" step="0.01" value="-0.5" style="width:70px"></label>
    <label style="margin-left:12px"><input type="checkbox" id="showBG" checked> 背景着色</label>
    <label style="margin-left:8px"><input type="checkbox" id="showFused" checked> 综合指标</label>
    <label style="margin-left:8px"><input type="checkbox" id="showFactors"> 个别因子</label>
  </fieldset>

  <div class="canvas-box">
    <canvas id="c"></canvas>
  </div>
  <div id="tip" class="tooltip"></div>
  <div class="legend" id="rangeLabel"></div>

  <!-- 时间范围控制区域 - 移到图表下方 -->
  <fieldset>
    <legend>时间范围控制</legend>
    <div class="time-range-container">
      <div class="time-range-slider" id="timeRangeSlider">
        <div class="time-track"></div>
        <div class="time-selection" id="timeSelection"></div>
        <div class="time-handle time-handle-start" id="handleStart"></div>
        <div class="time-handle time-handle-end" id="handleEnd"></div>
      </div>
      <div class="time-labels" id="timeLabels"></div>
      <div class="range-info" style="display:none;">
        <span id="rangeInfo">选择时间范围</span>
      </div>
    </div>
    
    <div class="src">
      <input id="csvUrl" type="url" placeholder="粘贴 Google Sheet 链接（CSV 或 /edit#gid= 链接均可）" />
      <button id="btnSaveSrc">保存链接</button>
      <button id="btnRefresh">立即更新</button>
      <span id="srcMsg" class="note"></span>
    </div>
  </fieldset>

  <!-- 权重配置区域已隐藏 -->
  <fieldset class="weight-config">
    <legend>权重配置（可修改，将自动标准化至 100%）</legend>
    <div class="presets">
      <span style="color:#374151;margin-right:8px">快速配置：</span>
      <div class="seg">
        <button type="button" id="p_equal" class="segbtn">等权重</button>
        <button type="button" id="p_macro" class="segbtn">宏观均衡</button>
        <button type="button" id="p_def" class="segbtn">防御型</button>
      </div>
      <span class="note" id="presetMsg"></span>
    </div>
    <table class="tbl" id="wtTbl">
      <thead><tr><th>因子</th><th>方向</th><th>权重(%)</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:6px">
      <button id="btnSaveW">保存权重</button>
      <span class="note" id="wtMsg"></span>
    </div>
  </fieldset>
</div>

<script>
const PRELOADED={rows: [{"Date": "2021-08-12", "BTC_USD": 44423.0, "USD_Index": 93.03, "TLT": 146.24, "HYG": 87.27, "US10Y_Yield": 1.361, "VIX": 15.59, "Nasdaq100": 15088.98, "SP500": 4460.8}, {"Date": "2021-08-13", "BTC_USD": 47842.0, "USD_Index": 92.52, "TLT": 148.55, "HYG": 87.46, "US10Y_Yield": 1.283, "VIX": 15.45, "Nasdaq100": 15136.68, "SP500": 4468.0}, {"Date": "2021-08-16", "BTC_USD": 45940.0, "USD_Index": 92.63, "TLT": 148.91, "HYG": 87.49, "US10Y_Yield": 1.268, "VIX": 16.12, "Nasdaq100": 15140.77, "SP500": 3479.7}, {"Date": "2021-08-17", "BTC_USD": 44698.0, "USD_Index": 93.13, "TLT": 148.85, "HYG": 87.29, "US10Y_Yield": 1.267, "VIX": 17.91, "Nasdaq100": 15002.83, "SP500": 4448.1}, {"Date": "2021-08-18", "BTC_USD": 44744.0, "USD_Index": 93.14, "TLT": 149.35, "HYG": 87.09, "US10Y_Yield": 1.26, "VIX": 21.57, "Nasdaq100": 14857.92, "SP500": 4400.3}, {"Date": "2021-08-19", "BTC_USD": 46765.0, "USD_Index": 93.57, "TLT": 150.45, "HYG": 87.08, "US10Y_Yield": 1.243, "VIX": 21.67, "Nasdaq100": 14933.93, "SP500": 4405.8}, {"Date": "2021-08-20", "BTC_USD": 49332.0, "USD_Index": 93.5, "TLT": 150.55, "HYG": 87.29, "US10Y_Yield": 1.255, "VIX": 18.56, "Nasdaq100": 15092.57, "SP500": 4441.7}, {"Date": "2021-08-23", "BTC_USD": 49539.0, "USD_Index": 92.96, "TLT": 150.45, "HYG": 87.56, "US10Y_Yield": 1.253, "VIX": 17.15, "Nasdaq100": 15312.82, "SP500": 4479.5}, {"Date": "2021-08-24", "BTC_USD": 47714.0, "USD_Index": 92.89, "TLT": 149.28, "HYG": 87.68, "US10Y_Yield": 1.297, "VIX": 17.22, "Nasdaq100": 15357.68, "SP500": 4486.2}, {"Date": "2021-08-25", "BTC_USD": 48989.0, "USD_Index": 92.83, "TLT": 148.04, "HYG": 87.77, "US10Y_Yield": 1.349, "VIX": 16.79, "Nasdaq100": 15368.92, "SP500": 4496.2}, {"Date": "2021-08-26", "BTC_USD": 46832.0, "USD_Index": 93.06, "TLT": 148.45, "HYG": 87.72, "US10Y_Yield": 1.354, "VIX": 18.84, "Nasdaq100": 15278.52, "SP500": 4470.0}, {"Date": "2021-08-27", "BTC_USD": 49076.1, "USD_Index": 92.69, "TLT": 149.46, "HYG": 87.96, "US10Y_Yield": 1.31, "VIX": 16.39, "Nasdaq100": 15432.95, "SP500": 4509.4}, {"Date": "2021-08-30", "BTC_USD": 47008.0, "USD_Index": 92.65, "TLT": 149.85, "HYG": 88.07, "US10Y_Yield": 1.28, "VIX": 16.19, "Nasdaq100": 15605.09, "SP500": 4528.8}, {"Date": "2021-08-31", "BTC_USD": 47157.0, "USD_Index": 92.63, "TLT": 148.83, "HYG": 88.09, "US10Y_Yield": 1.307, "VIX": 16.48, "Nasdaq100": 15582.51, "SP500": 4522.7}, {"Date": "2021-09-01", "BTC_USD": 48844.0, "USD_Index": 92.45, "TLT": 148.89, "HYG": 87.89, "US10Y_Yield": 1.299, "VIX": 16.11, "Nasdaq100": 15611.57, "SP500": 4524.1}, {"Date": "2021-09-02", "BTC_USD": 49291.0, "USD_Index": 92.22, "TLT": 149.54, "HYG": 88.0, "US10Y_Yield": 1.285, "VIX": 16.41, "Nasdaq100": 15604.25, "SP500": 4536.9}, {"Date": "2021-09-03", "BTC_USD": 50000.0, "USD_Index": 92.03, "TLT": 148.18, "HYG": 88.01, "US10Y_Yield": 1.326, "VIX": 16.41, "Nasdaq100": 15652.86, "SP500": 4535.4}, {"Date": "2021-09-07", "BTC_USD": 46778.0, "USD_Index": 92.51, "TLT": 146.93, "HYG": 87.78, "US10Y_Yield": 1.377, "VIX": 18.14, "Nasdaq100": 15675.76, "SP500": 4520.0}, {"Date": "2021-09-08", "BTC_USD": 46088.0, "USD_Index": 92.65, "TLT": 147.93, "HYG": 87.88, "US10Y_Yield": 1.336, "VIX": 17.96, "Nasdaq100": 15620.85, "SP500": 4514.1}, {"Date": "2021-09-09", "BTC_USD": 46389.0, "USD_Index": 92.48, "TLT": 149.72, "HYG": 87.96, "US10Y_Yield": 1.297, "VIX": 18.8, "Nasdaq100": 15561.05, "SP500": 4493.3}, {"Date": "2021-09-10", "BTC_USD": 44852.0, "USD_Index": 92.58, "TLT": 148.4, "HYG": 87.83, "US10Y_Yield": 1.343, "VIX": 20.95, "Nasdaq100": 15440.75, "SP500": 4458.6}, {"Date": "2021-09-13", "BTC_USD": 44960.0, "USD_Index": 92.67, "TLT": 149.3, "HYG": 88.05, "US10Y_Yield": 1.326, "VIX": 19.37, "Nasdaq100": 15434.5, "SP500": 4468.7}, {"Date": "2021-09-14", "BTC_USD": 47078.0, "USD_Index": 92.62, "TLT": 151.11, "HYG": 88.01, "US10Y_Yield": 1.284, "VIX": 19.46, "Nasdaq100": 15382.9, "SP500": 4443.1}, {"Date": "2021-09-15", "BTC_USD": 48136.0, "USD_Index": 92.55, "TLT": 150.58, "HYG": 88.14, "US10Y_Yield": 1.304, "VIX": 18.18, "Nasdaq100": 15503.53, "SP500": 4480.7}, {"Date": "2021-09-16", "BTC_USD": 47786.0, "USD_Index": 92.93, "TLT": 149.89, "HYG": 88.11, "US10Y_Yield": 1.336, "VIX": 18.69, "Nasdaq100": 15515.91, "SP500": 4473.8}, {"Date": "2021-09-17", "BTC_USD": 47292.0, "USD_Index": 93.19, "TLT": 149.17, "HYG": 88.0, "US10Y_Yield": 1.363, "VIX": 20.81, "Nasdaq100": 15333.47, "SP500": 4433.0}, {"Date": "2021-09-20", "BTC_USD": 43002.0, "USD_Index": 93.28, "TLT": 151.02, "HYG": 87.69, "US10Y_Yield": 1.312, "VIX": 25.71, "Nasdaq100": 15012.18, "SP500": 4357.7}, {"Date": "2021-09-21", "BTC_USD": 40664.0, "USD_Index": 93.2, "TLT": 150.89, "HYG": 87.84, "US10Y_Yield": 1.328, "VIX": 24.36, "Nasdaq100": 15027.77, "SP500": 4354.2}, {"Date": "2021-09-22", "BTC_USD": 43582.6, "USD_Index": 93.46, "TLT": 151.79, "HYG": 88.0, "US10Y_Yield": 1.304, "VIX": 20.87, "Nasdaq100": 15176.51, "SP500": 4395.6}, {"Date": "2021-09-23", "BTC_USD": 44882.0, "USD_Index": 93.03, "TLT": 148.36, "HYG": 88.04, "US10Y_Yield": 1.435, "VIX": 18.63, "Nasdaq100": 15316.58, "SP500": 4449.0}, {"Date": "2021-09-24", "BTC_USD": 42878.0, "USD_Index": 93.33, "TLT": 146.91, "HYG": 87.91, "US10Y_Yield": 1.453, "VIX": 17.75, "Nasdaq100": 15329.68, "SP500": 4455.5}, {"Date": "2021-09-27", "BTC_USD": 42191.0, "USD_Index": 93.38, "TLT": 146.37, "HYG": 87.83, "US10Y_Yield": 1.491, "VIX": 18.76, "Nasdaq100": 15204.83, "SP500": 4443.1}, {"Date": "2021-09-28", "BTC_USD": 41064.0, "USD_Index": 93.77, "TLT": 144.09, "HYG": 87.43, "US10Y_Yield": 1.546, "VIX": 23.25, "Nasdaq100": 14770.3, "SP500": 4352.6}, {"Date": "2021-09-29", "BTC_USD": 41551.0, "USD_Index": 94.34, "TLT": 144.34, "HYG": 87.59, "US10Y_Yield": 1.524, "VIX": 22.56, "Nasdaq100": 14752.89, "SP500": 4359.5}, {"Date": "2021-09-30", "BTC_USD": 43830.0, "USD_Index": 94.23, "TLT": 144.32, "HYG": 87.49, "US10Y_Yield": 1.492, "VIX": 23.14, "Nasdaq100": 14689.62, "SP500": 4307.5}]};

// 中文状态映射
const STATE_NAMES = {
  'Green': '多头',
  'Red': '空头', 
  'Range': '中性'
};

// 因子中文名称映射
const FACTOR_NAMES = {
  'BTC_USD': '比特币',
  'USD_Index': '美元指数',
  'TLT': '长期国债',
  'HYG': '高收益债',
  'US10Y_Yield': '10年期国债收益率',
  'VIX': '恐慌指数',
  'Nasdaq100': '纳斯达克100',
  'SP500': '标普500'
};

const KEY_STATE='us8f_state', KEY_SRC='us8f_src', KEY_W='us8f_w';
const DEFAULT_SRC='https://docs.google.com/spreadsheets/d/e/2PACX-1vSGmh5kmPMHI-v0fpNn0Lx1kwSN6WLQ3_3DNSx73PDZjR0P51DXUN8Xulw_gZg5RVLROJhFCCE9_ImA/pub?gid=1237541795&single=true&output=csv';
const FACTORS=['BTC_USD','USD_Index','TLT','HYG','US10Y_Yield','VIX','Nasdaq100','SP500'];
const DEFAULT_W={ // direction: +1/-1；weight: 百分比（合計不必=100，會自動正規化）
  'BTC_USD':{dir:1,w:12.5}, 'USD_Index':{dir:-1,w:12.5}, 'TLT':{dir:-1,w:12.5}, 'HYG':{dir:1,w:12.5},
  'US10Y_Yield':{dir:1,w:12.5}, 'VIX':{dir:-1,w:12.5}, 'Nasdaq100':{dir:1,w:12.5}, 'SP500':{dir:1,w:12.5}
};

const $=s=>document.querySelector(s);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const cssVar=(n,f)=>getComputedStyle(document.documentElement).getPropertyValue(n).trim()||f;
const COLORS={bgG:cssVar('--green-bg','#EAF7F0'),bgR:cssVar('--red-bg','#FDEAEA'),bgN:cssVar('--range-bg','#F6F7FB'),
  grid:cssVar('--grid','#d1d5db'), fused:cssVar('--fused','#2563eb'),
  c1:cssVar('--c1','#0ea5e9'),c2:cssVar('--c2','#f97316'),c3:cssVar('--c3','#059669'),c4:cssVar('--c4','#a855f7'),
  c5:cssVar('--c5','#ef4444'),c6:cssVar('--c6','#14b8a6'),c7:cssVar('--c7','#64748b'),c8:cssVar('--c8','#d97706')};

let rows=PRELOADED.rows.slice(); 
rows.sort((a,b)=>a.Date.localeCompare(b.Date));
let weights = loadWeights() || DEFAULT_W;
let start=0,end=0;
const c=$('#c'); 
const ctx=c.getContext('2d'); 
const tip=$('#tip');
const timeRangeSlider=$('#timeRangeSlider'), timeSelection=$('#timeSelection'), 
      handleStart=$('#handleStart'), handleEnd=$('#handleEnd'),
      timeLabels=$('#timeLabels'), rangeInfo=$('#rangeInfo');
const thrGEl=$('#thrG'),thrREl=$('#thrR'); 
const showBG=$('#showBG'), showFused=$('#showFused'), showFactors=$('#showFactors');
const stateBadge=$('#stateBadge'), rangeLabel=$('#rangeLabel');
const csvUrlEl=$('#csvUrl'), btnSaveSrc=$('#btnSaveSrc'), btnRefresh=$('#btnRefresh'), srcMsg=$('#srcMsg');
const wtTbl=$('#wtTbl tbody'), btnSaveW=$('#btnSaveW'), wtMsg=$('#wtMsg');

// === 全局变量 ===
let EVENTS=[];           // 當前視窗內的事件點（供繪圖與 hover）
let STATES=[];           // 每日狀態快取（Green / Range / Red）
let COMP=[], PAD={L:0,R:0,W:0}; // 當前計算結果及畫布邊界資訊

function stateOf(score, g, r){
  if (!isFinite(score)) return 'Range';
  if (score >= g) return 'Green';
  if (score <= r) return 'Red';
  return 'Range';
}

// 簡單的座標映射
function xAt(i, x0, x1, start, end){
  const n = Math.max(1, end - start - 1);
  return x0 + (i - start) * (x1 - x0) / n;
}

// === 工具提示 ===
function showTip(x, y, lines){
  tip.textContent = lines.join('\n');
  tip.style.opacity = 1;
  tip.style.left = (x + 12) + 'px';
  tip.style.top  = (y + 12) + 'px';
}
function hideTip(){ tip.style.opacity = 0; }

c.addEventListener('mousemove', (ev)=>{
  const rect = c.getBoundingClientRect();
  const mx = ev.clientX - rect.left;
  const my = ev.clientY - rect.top;

  if (!COMP.length) { hideTip(); return; }
  if (mx < PAD.L || mx > PAD.W - PAD.R) { hideTip(); return; }

  const usableW = PAD.W - PAD.L - PAD.R;
  const n = Math.max(1, end - start - 1);
  let idx = Math.round(start + (mx - PAD.L) * n / usableW);
  idx = Math.max(start, Math.min(end - 1, idx));
  const data = COMP[idx];
  if (!data) { hideTip(); return; }
  let amber=false, red=false;
  for (const e of EVENTS){ if (e.i === idx){ amber=e.amber; red=e.red; break; } }
  showTip(ev.clientX, ev.clientY, [
    `日期: ${data.date}`,
    `市场状态: ${STATE_NAMES[data.state] || data.state}`,
    `风险警示: ${amber ? '是' : '否'}`,
    `转空信号: ${red ? '是' : '否'}`
  ]);
});
c.addEventListener('mouseleave', hideTip);

function SMA(a,n,i){ if(i+1<n) return NaN; let s=0; for(let k=i-n+1;k<=i;k++) s+=a[k]; return s/n; }
function pct(a,p,i){ if(i<p) return NaN; const x=a[i-p], y=a[i]; if(x==null||x==0) return NaN; return (y-x)/x; }

// 正向風險因子（走強→加分）
function nRiskOn(arr,i){ const A=arr[i]>SMA(arr,200,i), B=arr[i]>SMA(arr,50,i), C=pct(arr,20,i)>0, D=pct(arr,60,i)>0; const s=(A+B+C+D)/4; return s*2-1; }
// 反向風險因子（走弱→加分）
function nRiskRev(arr,i){ const A=arr[i]<SMA(arr,200,i), B=arr[i]<SMA(arr,50,i), C=pct(arr,20,i)<0, D=pct(arr,60,i)<0; const s=(A+B+C+D)/4; return s*2-1; }

// VIX 特製：1 年（252 交易日）百分位；越低越好 → 高分
function nVIXpct(arr,i){
  const L=252; const aStart=Math.max(0,i-L+1); const win=arr.slice(aStart,i+1).filter(v=>isFinite(v));
  if(win.length<30){ // 數據不足時退回到「波動率下行加分」
    const A=arr[i]<SMA(arr,50,i), C=pct(arr,20,i)<0, D=pct(arr,60,i)<0; const s=(A+C+D)/3; return s*2-1;
  }
  const sorted=win.slice().sort((x,y)=>x-y);
  let r=0; while(r<sorted.length && sorted[r]<=arr[i]) r++; const p=r/sorted.length;
  const score = 1 - 2*p; // p=0 → +1（極低）；p=1 → -1（極高）
  return Math.max(-1,Math.min(1,score));
}

function compute(rows, thrG, thrR){
  const series={}; FACTORS.forEach(f=> series[f]=rows.map(r=>+r[f]));
  const n=rows.length; const out=[];
  for(let i=0;i<n;i++){ const v={};
    v['BTC_USD']=nRiskOn(series['BTC_USD'],i);
    v['USD_Index']=nRiskRev(series['USD_Index'],i);
    v['TLT']=nRiskRev(series['TLT'],i);
    v['HYG']=nRiskOn(series['HYG'],i);
    v['US10Y_Yield']=nRiskOn(series['US10Y_Yield'],i);
    v['VIX']=nVIXpct(series['VIX'],i); // ★ 使用 1Y 百分位
    v['Nasdaq100']=nRiskOn(series['Nasdaq100'],i);
    v['SP500']=nRiskOn(series['SP500'],i);
    for(const k in v) if(!isFinite(v[k])) v[k]=0;
    const w = getWVec(); let fused=0; FACTORS.forEach((f,idx)=> fused += v[f]*w[idx]);
    const disp=Math.max(-4,Math.min(4,fused*4));
    const st=fused>=thrG?'Green':(fused<=thrR?'Red':'Range');
    out.push({date:rows[i].Date, vals:v, fused, disp, state:st});
  }
  return out;
}

function getWVec(){
  const arr=[]; let sum=0; FACTORS.forEach(f=> sum+=Math.max(0, +weights[f]?.w || 0));
  if(sum<=0) sum=1;
  FACTORS.forEach(f=> arr.push( (Math.max(0,+weights[f]?.w||0)/sum) * 1 )); 
  return arr;
}

function resize(){ 
  c.width=c.clientWidth*devicePixelRatio; 
  c.height=c.clientHeight*devicePixelRatio; 
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); 
  // 重新计算时间范围显示
  if(rows.length > 0) {
    applyBounds(rows.length);
  }
  draw(); 
}
window.addEventListener('resize', resize);

const DEFAULT_VIEW_DAYS=90;
function applyBounds(n){
  if(n === 0) return;
  
  // 确保范围有效
  start = Math.max(0, Math.min(start, n-1));
  end = Math.max(start+1, Math.min(end, n));
  
  // 更新时间轴标签
  updateTimeLabels(n);
  
  // 更新选择器显示
  updateTimeRangeDisplay(n);
  
  // 更新范围信息
  updateRangeInfo(n);
}

function updateTimeLabels(n) {
  if(n === 0) return;
  
  const labelCount = 8; // 显示8个时间标签
  let labels = '';
  
  for(let i = 0; i < labelCount; i++) {
    const idx = Math.floor(i * (n-1) / (labelCount-1));
    const date = rows[idx]?.Date || '';
    const shortDate = date ? date.slice(5) : ''; // 只显示月-日
    labels += `<div class="time-label">${shortDate}</div>`;
  }
  
  timeLabels.innerHTML = labels;
}

function updateTimeRangeDisplay(n) {
  if(n === 0) return;
  
  const sliderWidth = timeRangeSlider.clientWidth;
  const startPercent = start / (n-1) * 100;
  const endPercent = end / (n-1) * 100;
  
  // 更新选择区域
  timeSelection.style.left = `${startPercent}%`;
  timeSelection.style.width = `${endPercent - startPercent}%`;
  
  // 更新手柄位置
  handleStart.style.left = `calc(${startPercent}% - 11px)`;
  handleEnd.style.left = `calc(${endPercent}% - 11px)`;
}

function updateRangeInfo(n) {
  const days = end - start;
  const startDate = rows[start]?.Date || '';
  const endDate = rows[end-1]?.Date || '';
  rangeInfo.textContent = `${startDate} ~ ${endDate} (${days}天)`;
}

function setWindowByPreset(days,n){
  if(days===0){
    start=0;
    end=n;
    document.querySelectorAll('button[data-win]').forEach(b=>b.classList.remove('active'));
    $('#btnAll').classList.add('active');
  } else{ 
    const span=Math.min(days,n); 
    end=n; 
    start=Math.max(0,n-span);
    document.querySelectorAll('button[data-win]').forEach(b=>b.classList.remove('active')); 
    document.querySelector(`button[data-win="${days}"]`)?.classList.add('active'); 
  }
  applyBounds(n); 
  draw(); 
  saveState();
}

function draw(){
  const thrG=parseFloat(thrGEl.value||0.5), thrR=parseFloat(thrREl.value||-0.5);
  const comp=compute(rows,thrG,thrR);
  COMP=comp;
  const W=c.clientWidth,H=c.clientHeight; 
  ctx.clearRect(0,0,W,H);
  if(comp.length===0) return;
  if(end===0){ 
    const span=Math.min(DEFAULT_VIEW_DAYS, Math.max(1,comp.length-1)); 
    end=comp.length; start=Math.max(0,end-span);
  }
  applyBounds(comp.length);
  const view=comp.slice(start,end);
  const latest=comp[comp.length-1].state; 
  stateBadge.textContent='市场状态：' + (STATE_NAMES[latest] || latest); 
  stateBadge.className='badge status '+(latest==='Green'?'':(latest==='Red'?'red':'range'));
  const padL=52,padR=22,padT=20,padB=48;
  PAD={L:padL,R:padR,W:W};
  const x=i=> padL + ((W-padL-padR)*(i/(view.length-1||1)));
  const y=v=>{ const mn=-4.2,mx=4.2; return padT + (1-(v-mn)/(mx-mn))*(H-padT-padB); };
  
  if($('#showBG').checked && view.length>0){ 
    let s=0,cur=view[0].state; 
    for(let i=1;i<view.length;i++){ 
      if(view[i].state!==cur){ shade(s,i-1,cur); s=i; cur=view[i].state; } 
    } 
    shade(s,view.length-1,cur);
    function shade(a,b,st){ 
      const color=st==='Green'?COLORS.bgG:(st==='Red'?COLORS.bgR:COLORS.bgN); 
      const x0=x(a),x1=x(b); 
      ctx.fillStyle=color; 
      ctx.fillRect(x0,padT,Math.max(1,x1-x0),H-padT-padB); 
    } 
  }
  
  ctx.strokeStyle=COLORS.grid; ctx.setLineDash([4,4]); ctx.beginPath(); 
  [-3,-2,-1,0,1,2,3].forEach(v=>{const yy=y(v); ctx.moveTo(padL,yy); ctx.lineTo(W-padR,yy);}); 
  ctx.stroke(); ctx.setLineDash([]);
  
  function drawLine(arr,color,lw=1.8){ 
    ctx.strokeStyle=color; ctx.lineWidth=lw; ctx.beginPath(); 
    for(let i=0;i<arr.length;i++){ 
      const px=x(i),py=y(arr[i]); 
      i?ctx.lineTo(px,py):ctx.moveTo(px,py);
    } 
    ctx.stroke(); 
  }
  
  if(showFused.checked) drawLine(view.map(d=>d.disp), COLORS.fused, 2.8);
  if(showFactors.checked){ 
    const cols=[COLORS.c1,COLORS.c2,COLORS.c3,COLORS.c4,COLORS.c5,COLORS.c6,COLORS.c7,COLORS.c8];
    FACTORS.forEach((f,idx)=>{ 
      const arr=view.map(d=>d.vals[f]*4); 
      drawLine(arr, cols[idx%cols.length], 1.4); 
    });
  }
  
  ctx.fillStyle='#64748b'; ctx.font='12px system-ui'; ctx.textAlign='center';
  ctx.fillText(view[0]?.date||'', padL, H-20); 
  ctx.fillText(view[Math.floor((view.length-1)/2)]?.date||'', (W)/2, H-20); 
  ctx.fillText(view[view.length-1]?.date||'', W-padR, H-20);
  rangeLabel.textContent=`${view[0]?.date||''} ~ ${view[view.length-1]?.date||''}（${view.length} 天）`;
  
  // === 構建 STATES & EVENTS，然後繪製事件點 ===
  const g = +thrGEl.value, r = +thrREl.value;
  STATES = new Array(comp.length).fill('Range');
  for (let i = 0; i < comp.length; i++) {
    STATES[i] = stateOf(comp[i].fused, g, r);
  }

  EVENTS = [];
  for (let i = Math.max(start+1, 1); i < end; i++) {
    const s0 = STATES[i-1], s1 = STATES[i];
    const amber = ((s0==='Green' && s1==='Range') || (s0==='Range' && s1==='Green'));
    const red   = (s0!=='Red' && s1==='Red');
    if (amber || red) {
      const x = xAt(i, padL, W-padR, start, end);
      const y = red ? (H - padB - 10) : (padT + 10); // Red 底部，Amber 頂部
      EVENTS.push({i, x, y, amber, red, date: comp[i].date, state: s1});
    }
  }

  // 繪製事件點（Amber 橙、Red 紅）
  for (const e of EVENTS) {
    ctx.beginPath();
    ctx.fillStyle = e.red ? '#ef4444' : '#f59e0b'; // red-500 / amber-500
    ctx.arc(e.x, e.y, e.red ? 5 : 4, 0, Math.PI*2);
    ctx.fill();
  }

  saveState();
}

function hookSliders(){
  let isDragging = false;
  let dragTarget = null;
  let initialMouseX = 0;
  let initialStart = 0;
  let initialEnd = 0;
  
  // 处理手柄拖拽
  function handleMouseDown(e, target) {
    isDragging = true;
    dragTarget = target;
    initialMouseX = e.clientX;
    initialStart = start;
    initialEnd = end;
    
    timeRangeSlider.classList.add('dragging');
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    e.preventDefault();
  }
  
  function handleMouseMove(e) {
    if (!isDragging || !dragTarget) return;
    
    const rect = timeRangeSlider.getBoundingClientRect();
    const sliderWidth = rect.width;
    const deltaX = e.clientX - initialMouseX;
    const deltaPercent = (deltaX / sliderWidth) * 100;
    const deltaIndex = Math.round((deltaPercent / 100) * (rows.length - 1));
    
    if (dragTarget === 'start') {
      start = Math.max(0, Math.min(initialStart + deltaIndex, end - 5)); // 最少5天间隔
    } else if (dragTarget === 'end') {
      end = Math.max(start + 5, Math.min(initialEnd + deltaIndex, rows.length)); // 最少5天间隔
    }
    
    applyBounds(rows.length);
    draw();
  }
  
  function handleMouseUp() {
    isDragging = false;
    dragTarget = null;
    timeRangeSlider.classList.remove('dragging');
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    saveState();
  }
  
  // 绑定手柄事件
  handleStart.addEventListener('mousedown', (e) => handleMouseDown(e, 'start'));
  handleEnd.addEventListener('mousedown', (e) => handleMouseDown(e, 'end'));
  
  // 点击轨道设置范围中心
  timeRangeSlider.addEventListener('click', (e) => {
    if (e.target === handleStart || e.target === handleEnd) return;
    
    const rect = timeRangeSlider.getBoundingClientRect();
    const clickPercent = (e.clientX - rect.left) / rect.width;
    const clickIndex = Math.round(clickPercent * (rows.length - 1));
    const currentSpan = end - start;
    
    start = Math.max(0, Math.min(clickIndex - Math.floor(currentSpan/2), rows.length - currentSpan));
    end = start + currentSpan;
    
    applyBounds(rows.length);
    draw();
    saveState();
  });
}

document.querySelectorAll('button[data-win]').forEach(btn=> 
  btn.addEventListener('click',()=>{ 
    document.querySelectorAll('button[data-win]').forEach(b=>b.classList.remove('active')); 
    btn.classList.add('active'); 
    const days=parseInt(btn.dataset.win)||0; 
    setWindowByPreset(days,rows.length); 
  })
);

[thrGEl,thrREl,showBG,showFused,showFactors].forEach(el=> 
  el.addEventListener('change', ()=>{ draw(); saveState(); })
);

function saveState(){
  const s={
    thrG:+thrGEl.value,
    thrR:+thrREl.value,
    showBG:showBG.checked,
    showFused:showFused.checked,
    showFactors:showFactors.checked,
    startDate: rows[Math.max(0,Math.min(start,rows.length-1))]?.Date || null,
    endDate: rows[Math.max(0,Math.min(end-1,rows.length-1))]?.Date || null 
  };
  try{ localStorage.setItem(KEY_STATE, JSON.stringify(s)); }catch(e){}
}
function loadState(){ 
  try{ return JSON.parse(localStorage.getItem(KEY_STATE)||'null'); }catch(e){ return null; } 
}

function buildWTable(){
  wtTbl.innerHTML='';
  FACTORS.forEach(f=>{ 
    const tr=document.createElement('tr');
    const dir = (weights[f]?.dir||1)>=0? '+':'-';
    const w = (weights[f]?.w ?? 12.5);
    const factorDisplayName = FACTOR_NAMES[f] || f;
    tr.innerHTML=`<td>${factorDisplayName}</td>
      <td><button type="button" data-f="${f}" class="btnDir">${dir}</button></td>
      <td><input type="number" step="0.1" value="${w}" data-f="${f}" class="inpW"></td>`;
    wtTbl.appendChild(tr);
  });
  wtTbl.querySelectorAll('.btnDir').forEach(btn=> 
    btn.addEventListener('click',()=>{ 
      const f=btn.dataset.f; 
      const cur=(weights[f]?.dir||1)>=0?1:-1; 
      weights[f]={...weights[f], dir: -cur}; 
      btn.textContent = cur>0?'-':'+'; 
    })
  );
}

btnSaveW.addEventListener('click',()=>{ 
  wtTbl.querySelectorAll('.inpW').forEach(inp=>{ 
    const f=inp.dataset.f; 
    const v=parseFloat(inp.value)||0; 
    weights[f]={...weights[f], w: v}; 
  });
  saveWeights(weights); 
  wtMsg.textContent='权重已保存（已自动标准化）'; 
  setTimeout(()=>wtMsg.textContent='',2000); 
  draw();
});

function loadWeights(){ 
  try{ return JSON.parse(localStorage.getItem(KEY_W)||'null'); }catch(e){ return null; } 
}
function saveWeights(w){
  let sum=0; FACTORS.forEach(f=> sum+=Math.max(0, +w[f]?.w||0)); 
  if(sum<=0) sum=1;
  const out={}; 
  FACTORS.forEach(f=> out[f]={
    dir: (w[f]?.dir||1)>=0?1:-1, 
    w: (Math.max(0,+w[f]?.w||0)/sum)*100
  });
  try{ localStorage.setItem(KEY_W, JSON.stringify(out)); }catch(e){}
  weights=out;
}

function extractGvizUrl(anyUrl){
  try{ 
    const u=new URL(anyUrl); 
    const parts=u.pathname.split('/'); 
    const dIdx=parts.indexOf('d'); 
    if(dIdx!==-1 && parts[dIdx+1]){ 
      const id=parts[dIdx+1];
      const gid=u.searchParams.get('gid') || (u.hash.match(/gid=(\d+)/)?.[1]) || '0';
      return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&gid=${gid}`; 
    } 
    return anyUrl; 
  }catch{ return anyUrl; }
}

async function fetchCsvText(url){ 
  const u=new URL(url); 
  u.searchParams.set('_',Date.now().toString()); 
  const res=await fetch(u.toString(),{mode:'cors'}); 
  if(!res.ok) throw new Error('HTTP '+res.status); 
  return await res.text(); 
}

function parseCsv(text){
  const lines=text.trim().split(/\r?\n/); 
  const header=lines.shift().split(',').map(s=>s.trim());
  const need=['Date','BTC_USD','USD_Index','TLT','HYG','US10Y_Yield','VIX','Nasdaq100','SP500']; 
  const idx={}; need.forEach(k=> idx[k]=header.indexOf(k));
  if(Object.values(idx).some(i=>i<0)) throw new Error('CSV 字段不完整');
  const out=[]; 
  for(const ln of lines){ 
    if(!ln.trim()) continue; 
    const arr=ln.split(',').map(s=>s.trim());
    out.push({
      Date:arr[idx.Date], 
      BTC_USD:+arr[idx.BTC_USD], 
      USD_Index:+arr[idx.USD_Index], 
      TLT:+arr[idx.TLT], 
      HYG:+arr[idx.HYG], 
      US10Y_Yield:+arr[idx.US10Y_Yield], 
      VIX:+arr[idx.VIX], 
      Nasdaq100:+arr[idx.Nasdaq100], 
      SP500:+arr[idx.SP500]
    });
  } 
  return out;
}

async function fetchGvizJson(url){
  const u=new URL(url); 
  u.searchParams.set('tqx','out:json'); 
  u.searchParams.set('_',Date.now().toString());
  const res=await fetch(u.toString(),{mode:'cors'}); 
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text=await res.text(); 
  const m=text.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s); 
  if(!m) throw new Error('非 gviz JSON 格式');
  const obj=JSON.parse(m[1]); 
  const cols=obj.table.cols.map(c=>c.label);
  const need=['Date','BTC_USD','USD_Index','TLT','HYG','US10Y_Yield','VIX','Nasdaq100','SP500']; 
  if(!need.every(k=>cols.includes(k))) throw new Error('表头不含必需字段');
  const cidx={}; need.forEach(k=> cidx[k]=cols.indexOf(k));
  const out=[]; 
  for(const r of obj.table.rows){ 
    if(!r.c) continue; 
    const toVal=c=> c? (c.f? c.f: c.v): null;
    const row={
      Date: toVal(r.c[cidx['Date']]), 
      BTC_USD:+toVal(r.c[cidx['BTC_USD']]), 
      USD_Index:+toVal(r.c[cidx['USD_Index']]), 
      TLT:+toVal(r.c[cidx['TLT']]), 
      HYG:+toVal(r.c[cidx['HYG']]), 
      US10Y_Yield:+toVal(r.c[cidx['US10Y_Yield']]), 
      VIX:+toVal(r.c[cidx['VIX']]), 
      Nasdaq100:+toVal(r.c[cidx['Nasdaq100']]), 
      SP500:+toVal(r.c[cidx['SP500']])
    }; 
    if(row.Date) out.push(row); 
  }
  return out;
}

async function reloadFromSource(){
  const input=(csvUrlEl.value||'').trim(); 
  if(!input){ 
    srcMsg.textContent='未设置数据源，使用内置数据'; 
    srcMsg.className='note'; 
    rows=PRELOADED.rows.slice(); 
    // 修正：设置为最新3个月而非start=0, end=0
    setWindowByPreset(90, rows.length);
    draw(); return; 
  }
  srcMsg.textContent='正在获取数据…'; 
  srcMsg.className='note';
  try{ 
    const csvText=await fetchCsvText(input); 
    const parsed=parseCsv(csvText); 
    if(parsed.length===0) throw new Error('CSV 无数据'); 
    rows=parsed; 
    // 修正：设置为最新3个月而非start=0, end=0
    setWindowByPreset(90, rows.length);
    draw(); 
    srcMsg.textContent='数据已更新（CSV）'; 
    srcMsg.className='note ok'; 
    try{ localStorage.setItem(KEY_SRC, input); }catch(e){}; 
    return; 
  }
  catch(e1){ 
    try{ 
      const gviz=extractGvizUrl(input); 
      const parsed=await fetchGvizJson(gviz); 
      if(parsed.length===0) throw new Error('gviz 无数据'); 
      rows=parsed; 
      // 修正：设置为最新3个月而非start=0, end=0
      setWindowByPreset(90, rows.length);
      draw(); 
      srcMsg.textContent='数据已更新（gviz JSON）'; 
      srcMsg.className='note ok'; 
      try{ localStorage.setItem(KEY_SRC, input); }catch(e){}; 
      return; 
    }
    catch(e2){ 
      console.error('CSV错误:',e1,'GVIZ错误:',e2); 
      srcMsg.textContent='获取数据失败（已回退至内置数据）'; 
      srcMsg.className='note err'; 
      rows=PRELOADED.rows.slice(); 
      // 修正：设置为最新3个月而非start=0, end=0
      setWindowByPreset(90, rows.length);
      draw(); 
    }
  }
}

btnSaveSrc.addEventListener('click',()=>{ 
  try{ 
    localStorage.setItem(KEY_SRC, (csvUrlEl.value||'').trim()); 
    srcMsg.textContent='链接已保存'; 
    srcMsg.className='note ok'; 
  }catch(e){} 
});
btnRefresh.addEventListener('click', reloadFromSource);

const KEY_W_PRESET='us8f_w_preset';
const PRESETS={
  equal:{ 
    w:{'BTC_USD':12.5,'USD_Index':12.5,'TLT':12.5,'HYG':12.5,'US10Y_Yield':12.5,'VIX':12.5,'Nasdaq100':12.5,'SP500':12.5},
    d:{'BTC_USD':1,'USD_Index':-1,'TLT':-1,'HYG':1,'US10Y_Yield':1,'VIX':-1,'Nasdaq100':1,'SP500':1} 
  },
  macro:{ 
    w:{'SP500':20,'Nasdaq100':15,'HYG':15,'VIX':15,'USD_Index':10,'US10Y_Yield':10,'TLT':10,'BTC_USD':5},
    d:{'BTC_USD':1,'USD_Index':-1,'TLT':-1,'HYG':1,'US10Y_Yield':1,'VIX':-1,'Nasdaq100':1,'SP500':1} 
  },
  defensive:{ 
    w:{'VIX':20,'USD_Index':15,'TLT':15,'SP500':15,'Nasdaq100':10,'HYG':10,'US10Y_Yield':10,'BTC_USD':5},
    d:{'BTC_USD':1,'USD_Index':-1,'TLT':-1,'HYG':1,'US10Y_Yield':1,'VIX':-1,'Nasdaq100':1,'SP500':1} 
  }
};

function applyPreset(name){
  const p=PRESETS[name]; if(!p) return;
  const tmp={};
  FACTORS.forEach(f=>{ tmp[f]={dir: (p.d[f]||1), w: (p.w[f]??0)}; });
  saveWeights(tmp); // normalize + persist
  // reflect to UI
  wtTbl.querySelectorAll('.inpW').forEach(inp=>{ 
    const f=inp.dataset.f; 
    inp.value=(+weights[f]?.w||0).toFixed(1); 
  });
  wtTbl.querySelectorAll('.btnDir').forEach(btn=>{ 
    const f=btn.dataset.f; 
    const cur=(weights[f]?.dir||1); 
    btn.textContent = cur>0?'+':'-'; 
  });
  try{ localStorage.setItem(KEY_W_PRESET, name); }catch{}
  const msg=$('#presetMsg'); 
  if(msg){ 
    msg.textContent='已应用「'+(name==='equal'?'等权重':name==='macro'?'宏观均衡':'防御型')+'」配置'; 
    setTimeout(()=>msg.textContent='',1500); 
  }
  document.querySelectorAll('.segbtn').forEach(b=>b.classList.remove('active'));
  const id = name==='equal'?'p_equal': name==='macro'?'p_macro':'p_def';
  $('#'+id)?.classList.add('active');
  draw();
}

document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='p_equal') applyPreset('equal');
  if(e.target && e.target.id==='p_macro') applyPreset('macro');
  if(e.target && e.target.id==='p_def') applyPreset('defensive');
});

try{ 
  const last = localStorage.getItem(KEY_W_PRESET); 
  if(last){ 
    const id = last==='equal'?'p_equal': last==='macro'?'p_macro':'p_def'; 
    document.getElementById(id)?.classList.add('active'); 
  } 
}catch{}

function bindWeightAutoNormalize(){
  let _t=null;
  const apply=()=>{
    const tmp={};
    wtTbl.querySelectorAll('.inpW').forEach(inp=>{
      const f=inp.dataset.f; 
      const v=parseFloat(inp.value)||0;
      tmp[f] = {...(weights[f]||{}), w: v};
    });
    saveWeights(tmp);
    wtTbl.querySelectorAll('.inpW').forEach(inp=>{
      const f=inp.dataset.f; 
      inp.value = ((+weights[f]?.w||0).toFixed(1));
    });
    draw();
  };
  wtTbl.addEventListener('input', (e)=>{
    if(e.target && e.target.classList && e.target.classList.contains('inpW')){
      if(_t) clearTimeout(_t); 
      _t=setTimeout(apply,200);
    }
  });
  wtTbl.addEventListener('change', (e)=>{
    if(e.target && e.target.classList && e.target.classList.contains('inpW')) apply();
  });
}

function init(){
  const st=loadState(); 
  if(st){ 
    try{ 
      thrGEl.value=isFinite(st.thrG)?st.thrG:0.5; 
      thrREl.value=isFinite(st.thrR)?st.thrR:-0.5; 
      showBG.checked=st.showBG!==false; 
      showFused.checked=st.showFused!==false; 
      showFactors.checked=!!st.showFactors; 
    }catch{} 
  }
  document.querySelectorAll('button[data-win]').forEach(b=>b.classList.remove('active')); 
  document.querySelector('button[data-win="90"]').classList.add('active');
  buildWTable();
  setWindowByPreset(90, rows.length); 
  hookSliders(); 
  resize();
  const savedSrc=(localStorage.getItem(KEY_SRC)||'').trim();
  csvUrlEl.value = savedSrc || DEFAULT_SRC;
  if(csvUrlEl.value) reloadFromSource();
  bindWeightAutoNormalize();
}

init();
</script>
</body>
</html>
