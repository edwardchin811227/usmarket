<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>美股 8因子仪表板 — v1（VIX 1年百分位）</title>
<style>
:root{ --bg:#ffffff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--grid:#d1d5db;
       --fused:#2563eb;--c1:#0ea5e9;--c2:#f97316;--c3:#059669;--c4:#a855f7;--c5:#ef4444;--c6:#14b8a6;--c7:#64748b;--c8:#d97706;
       --green-bg:#EAF7F0;--range-bg:#F6F7FB;--red-bg:#FDEAEA; }
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto}
.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:2}
.badge{padding:2px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700}
.status{color:#065f46;background:#d1fae5;border-color:#a7f3d0}.status.red{color:#991b1b;background:#fee2e2;border-color:#fecaca}.status.range{color:#334155;background:#e2e8f0;border-color:#cbd5e1}
.btns button{padding:4px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.btns button.active{background:#111827;color:#fff;border-color:#111827}
.canvas-box{position:relative;margin:12px;height:56vh;min-height:360px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
canvas{width:100%;height:100%;display:block;background:#fff}
.tooltip{position:fixed;pointer-events:none;background:#111827;color:#fff;padding:8px 10px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .12s;max-width:260px;box-shadow:0 8px 20px rgba(0,0,0,.15)}
.legend{font-size:12px;color:#374151;display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:0 12px 8px}
.sliders{display:flex;gap:12px;align-items:center;justify-content:center;margin:0}
.slider{display:flex;align-items:center;gap:8px}
.slider label{width:46px;text-align:right;color:#374151}
.slider input[type=range]{flex:1;height:28px;-webkit-appearance:none;background:transparent}
.slider input[type=range]::-webkit-slider-runnable-track{height:10px;background:#e5e7eb;border-radius:999px}
.slider input[type=range]::-moz-range-track{height:10px;background:#e5e7eb;border-radius:999px}
.slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;margin-top:-6px;background:#111827;border:2px solid #fff;box-shadow:0 1px 2px rgba(0,0,0,.25)}
.slider.start input[type=range]::-webkit-slider-thumb{background:#059669}
.slider.mid   input[type=range]::-webkit-slider-thumb{background:#2563eb}
.slider.end   input[type=range]::-webkit-slider-thumb{background:#ef4444}
fieldset{border:1px dashed var(--border);padding:6px 10px;border-radius:10px;margin:8px 12px}
legend{padding:0 6px;color:#374151}
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th,.tbl td{border:1px solid var(--border);padding:6px 8px;text-align:center}
.tbl input[type=number]{width:80px}
.src{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
.src input[type=url]{width:460px;max-width:70vw;padding:6px 8px;border:1px solid var(--border);border-radius:8px}
.src button{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
.note{color:#64748b;font-size:12px;margin-left:8px}
.err{color:#991b1b}.ok{color:#047857}

.presets{display:flex;align-items:center;justify-content:center;gap:10px;margin:6px 0 10px}
.presets .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.presets .seg .segbtn{padding:6px 12px;background:#fff;border:0;border-right:1px solid var(--border);cursor:pointer}
.presets .seg .segbtn:last-child{border-right:0}
.presets .seg .segbtn.active{background:#111827;color:#fff}
/* sliders inside top toolbar */
.toolbar .sliders{margin:0;flex:1;max-width:640px}
.toolbar .sliders .slider label{width:42px}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div id="stateBadge" class="badge status">市场状态：—</div>
    <div class="btns">
      <button data-win="365">1年</button>
      <button data-win="180">6个月</button>
      <button data-win="90">3个月</button>
      <button data-win="30" class="active">1个月</button>
      <button data-win="0" id="btnAll">全部</button>
    </div>
    

  <div class="sliders">
    <div class="slider start"><label>起始</label><input id="sStart" type="range" min="0" max="100" value="0"></div>
    
    <div class="src">
      <input id="csvUrl" type="url" placeholder="粘贴 Google Sheet 链接（CSV 或 /edit#gid= 链接均可）" />
      <button id="btnSaveSrc">保存链接</button>
      <button id="btnRefresh">立即更新</button>
      <span id="srcMsg" class="note"></span>
    </div>
  </div>

  <fieldset>
    <legend>阈值与显示设置</legend>
    <label>多头区 ≥ <input id="thrG" type="number" step="0.01" value="0.5" style="width:70px"></label>
    <label style="margin-left:8px">空头区 ≤ <input id="thrR" type="number" step="0.01" value="-0.5" style="width:70px"></label>
    <label style="margin-left:12px"><input type="checkbox" id="showBG" checked> 背景着色</label>
    <label style="margin-left:8px"><input type="checkbox" id="showFused" checked> 综合指标</label>
    <label style="margin-left:8px"><input type="checkbox" id="showFactors"> 个别因子</label>
  </fieldset>

  <div class="canvas-box">
    <canvas id="c"></canvas>
  </div>
  <div id="tip" class="tooltip"></div>
  <div class="legend" id="rangeLabel"></div>

  <fieldset>
    <legend>权重配置（可修改，将自动标准化至 100%）</legend>
    <div class="presets">
      <span style="color:#374151;margin-right:8px">快速配置：</span>
      <div class="seg">
        <button type="button" id="p_equal" class="segbtn">等权重</button>
        <button type="button" id="p_macro" class="segbtn">宏观均衡</button>
        <button type="button" id="p_def" class="segbtn">防御型</button>
      </div>
      <span class="note" id="presetMsg"></span>
    </div>
    <table class="tbl" id="wtTbl">
      <thead><tr><th>因子</th><th>方向</th><th>权重(%)</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:6px">
      <button id="btnSaveW">保存权重</button>
      <span class="note" id="wtMsg"></span>
    </div>
  </fieldset><div class="slider mid"><label>中点</label><input id="sMid" type="range" min="0" max="100" value="50"></div>
    <div class="slider end"><label>结束</label><input id="sEnd" type="range" min="0" max="100" value="100"></div>
  </div>
</div>

<script>
const PRELOADED={rows: [{"Date": "2021-08-12", "BTC_USD": 44423.0, "USD_Index": 93.03, "TLT": 146.24, "HYG": 87.27, "US10Y_Yield": 1.361, "VIX": 15.59, "Nasdaq100": 15088.98, "SP500": 4460.8}, {"Date": "2021-08-13", "BTC_USD": 47842.0, "USD_Index": 92.52, "TLT": 148.55, "HYG": 87.46, "US10Y_Yield": 1.283, "VIX": 15.45, "Nasdaq100": 15136.68, "SP500": 4468.0}, {"Date": "2021-08-16", "BTC_USD": 45940.0, "USD_Index": 92.63, "TLT": 148.91, "HYG": 87.49, "US10Y_Yield": 1.268, "VIX": 16.12, "Nasdaq100": 15140.77, "SP500": 3479.7}, {"Date": "2021-08-17", "BTC_USD": 44698.0, "USD_Index": 93.13, "TLT": 148.85, "HYG": 87.29, "US10Y_Yield": 1.267, "VIX": 17.91, "Nasdaq100": 15002.83, "SP500": 4448.1}, {"Date": "2021-08-18", "BTC_USD": 44744.0, "USD_Index": 93.14, "TLT": 149.35, "HYG": 87.09, "US10Y_Yield": 1.26, "VIX": 21.57, "Nasdaq100": 14857.92, "SP500": 4400.3}, {"Date": "2021-08-19", "BTC_USD": 46765.0, "USD_Index": 93.57, "TLT": 150.45, "HYG": 87.08, "US10Y_Yield": 1.243, "VIX": 21.67, "Nasdaq100": 14933.93, "SP500": 4405.8}, {"Date": "2021-08-20", "BTC_USD": 49332.0, "USD_Index": 93.5, "TLT": 150.55, "HYG": 87.29, "US10Y_Yield": 1.255, "VIX": 18.56, "Nasdaq100": 15092.57, "SP500": 4441.7}, {"Date": "2021-08-23", "BTC_USD": 49539.0, "USD_Index": 92.96, "TLT": 150.45, "HYG": 87.56, "US10Y_Yield": 1.253, "VIX": 17.15, "Nasdaq100": 15312.82, "SP500": 4479.5}, {"Date": "2021-08-24", "BTC_USD": 47714.0, "USD_Index": 92.89, "TLT": 149.28, "HYG": 87.68, "US10Y_Yield": 1.297, "VIX": 17.22, "Nasdaq100": 15357.68, "SP500": 4486.2}, {"Date": "2021-08-25", "BTC_USD": 48989.0, "USD_Index": 92.83, "TLT": 148.04, "HYG": 87.77, "US10Y_Yield": 1.349, "VIX": 16.79, "Nasdaq100": 15368.92, "SP500": 4496.2}, {"Date": "2021-08-26", "BTC_USD": 46832.0, "USD_Index": 93.06, "TLT": 148.45, "HYG": 87.72, "US10Y_Yield": 1.354, "VIX": 18.84, "Nasdaq100": 15278.52, "SP500": 4470.0}, {"Date": "2021-08-27", "BTC_USD": 49076.1, "USD_Index": 92.69, "TLT": 149.46, "HYG": 87.96, "US10Y_Yield": 1.31, "VIX": 16.39, "Nasdaq100": 15432.95, "SP500": 4509.4}, {"Date": "2021-08-30", "BTC_USD": 47008.0, "USD_Index": 92.65, "TLT": 149.85, "HYG": 88.07, "US10Y_Yield": 1.28, "VIX": 16.19, "Nasdaq100": 15605.09, "SP500": 4528.8}, {"Date": "2021-08-31", "BTC_USD": 47157.0, "USD_Index": 92.63, "TLT": 148.83, "HYG": 88.09, "US10Y_Yield": 1.307, "VIX": 16.48, "Nasdaq100": 15582.51, "SP500": 4522.7}, {"Date": "2021-09-01", "BTC_USD": 48844.0, "USD_Index": 92.45, "TLT": 148.89, "HYG": 87.89, "US10Y_Yield": 1.299, "VIX": 16.11, "Nasdaq100": 15611.57, "SP500": 4524.1}, {"Date": "2021-09-02", "BTC_USD": 49291.0, "USD_Index": 92.22, "TLT": 149.54, "HYG": 88.0, "US10Y_Yield": 1.285, "VIX": 16.41, "Nasdaq100": 15604.25, "SP500": 4536.9}, {"Date": "2021-09-03", "BTC_USD": 50000.0, "USD_Index": 92.03, "TLT": 148.18, "HYG": 88.01, "US10Y_Yield": 1.326, "VIX": 16.41, "Nasdaq100": 15652.86, "SP500": 4535.4}, {"Date": "2021-09-07", "BTC_USD": 46778.0, "USD_Index": 92.51, "TLT": 146.93, "HYG": 87.78, "US10Y_Yield": 1.377, "VIX": 18.14, "Nasdaq100": 15675.76, "SP500": 4520.0}, {"Date": "2021-09-08", "BTC_USD": 46088.0, "USD_Index": 92.65, "TLT": 147.93, "HYG": 87.88, "US10Y_Yield": 1.336, "VIX": 17.96, "Nasdaq100": 15620.85, "SP500": 4514.1}, {"Date": "2021-09-09", "BTC_USD": 46389.0, "USD_Index": 92.48, "TLT": 149.72, "HYG": 87.96, "US10Y_Yield": 1.297, "VIX": 18.8, "Nasdaq100": 15561.05, "SP500": 4493.3}, {"Date": "2021-09-10", "BTC_USD": 44852.0, "USD_Index": 92.58, "TLT": 148.4, "HYG": 87.83, "US10Y_Yield": 1.343, "VIX": 20.95, "Nasdaq100": 15440.75, "SP500": 4458.6}, {"Date": "2021-09-13", "BTC_USD": 44960.0, "USD_Index": 92.67, "TLT": 149.3, "HYG": 88.05, "US10Y_Yield": 1.326, "VIX": 19.37, "Nasdaq100": 15434.5, "SP500": 4468.7}, {"Date": "2021-09-14", "BTC_USD": 47078.0, "USD_Index": 92.62, "TLT": 151.11, "HYG": 88.01, "US10Y_Yield": 1.284, "VIX": 19.46, "Nasdaq100": 15382.9, "SP500": 4443.1}, {"Date": "2021-09-15", "BTC_USD": 48136.0, "USD_Index": 92.55, "TLT": 150.58, "HYG": 88.14, "US10Y_Yield": 1.304, "VIX": 18.18, "Nasdaq100": 15503.53, "SP500": 4480.7}, {"Date": "2021-09-16", "BTC_USD": 47786.0, "USD_Index": 92.93, "TLT": 149.89, "HYG": 88.11, "US10Y_Yield": 1.336, "VIX": 18.69, "Nasdaq100": 15515.91, "SP500": 4473.8}, {"Date": "2021-09-17", "BTC_USD": 47292.0, "USD_Index": 93.19, "TLT": 149.17, "HYG": 88.0, "US10Y_Yield": 1.363, "VIX": 20.81, "Nasdaq100": 15333.47, "SP500": 4433.0}, {"Date": "2021-09-20", "BTC_USD": 43002.0, "USD_Index": 93.28, "TLT": 151.02, "HYG": 87.69, "US10Y_Yield": 1.312, "VIX": 25.71, "Nasdaq100": 15012.18, "SP500": 4357.7}, {"Date": "2021-09-21", "BTC_USD": 40664.0, "USD_Index": 93.2, "TLT": 150.89, "HYG": 87.84, "US10Y_Yield": 1.328, "VIX": 24.36, "Nasdaq100": 15027.77, "SP500": 4354.2}, {"Date": "2021-09-22", "BTC_USD": 43582.6, "USD_Index": 93.46, "TLT": 151.79, "HYG": 88.0, "US10Y_Yield": 1.304, "VIX": 20.87, "Nasdaq100": 15176.51, "SP500": 4395.6}, {"Date": "2021-09-23", "BTC_USD": 44882.0, "USD_Index": 93.03, "TLT": 148.36, "HYG": 88.04, "US10Y_Yield": 1.435, "VIX": 18.63, "Nasdaq100": 15316.58, "SP500": 4449.0}, {"Date": "2021-09-24", "BTC_USD": 42878.0, "USD_Index": 93.33, "TLT": 146.91, "HYG": 87.91, "US10Y_Yield": 1.453, "VIX": 17.75, "Nasdaq100": 15329.68, "SP500": 4455.5}, {"Date": "2021-09-27", "BTC_USD": 42191.0, "USD_Index": 93.38, "TLT": 146.37, "HYG": 87.83, "US10Y_Yield": 1.491, "VIX": 18.76, "Nasdaq100": 15204.83, "SP500": 4443.1}, {"Date": "2021-09-28", "BTC_USD": 41064.0, "USD_Index": 93.77, "TLT": 144.09, "HYG": 87.43, "US10Y_Yield": 1.546, "VIX": 23.25, "Nasdaq100": 14770.3, "SP500": 4352.6}, {"Date": "2021-09-29", "BTC_USD": 41551.0, "USD_Index": 94.34, "TLT": 144.34, "HYG": 87.59, "US10Y_Yield": 1.524, "VIX": 22.56, "Nasdaq100": 14752.89, "SP500": 4359.5}, {"Date": "2021-09-30", "BTC_USD": 43830.0, "USD_Index": 94.23, "TLT": 144.32, "HYG": 87.49, "US10Y_Yield": 1.492, "VIX": 23.14, "Nasdaq100": 14689.62, "SP500": 4307.5}]};

// 中文状态映射
const STATE_NAMES = {
  'Green': '多头',
  'Red': '空头', 
  'Range': '中性'
};

// 因子中文名称映射
const FACTOR_NAMES = {
  'BTC_USD': '比特币',
  'USD_Index': '美元指数',
  'TLT': '长期国债',
  'HYG': '高收益债',
  'US10Y_Yield': '10年期国债收益率',
  'VIX': '恐慌指数',
  'Nasdaq100': '纳斯达克100',
  'SP500': '标普500'
};

const KEY_STATE='us8f_state', KEY_SRC='us8f_src', KEY_W='us8f_w';
const DEFAULT_SRC='https://docs.google.com/spreadsheets/d/e/2PACX-1vSGmh5kmPMHI-v0fpNn0Lx1kwSN6WLQ3_3DNSx73PDZjR0P51DXUN8Xulw_gZg5RVLROJhFCCE9_ImA/pub?gid=1237541795&single=true&output=csv';
const FACTORS=['BTC_USD','USD_Index','TLT','HYG','US10Y_Yield','VIX','Nasdaq100','SP500'];
const DEFAULT_W={ // direction: +1/-1；weight: 百分比（合計不必=100，會自動正規化）
  'BTC_USD':{dir:1,w:12.5}, 'USD_Index':{dir:-1,w:12.5}, 'TLT':{dir:-1,w:12.5}, 'HYG':{dir:1,w:12.5},
  'US10Y_Yield':{dir:1,w:12.5}, 'VIX':{dir:-1,w:12.5}, 'Nasdaq100':{dir:1,w:12.5}, 'SP500':{dir:1,w:12.5}
};

const $=s=>document.querySelector(s);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const cssVar=(n,f)=>getComputedStyle(document.documentElement).getPropertyValue(n).trim()||f;
const COLORS={bgG:cssVar('--green-bg','#EAF7F0'),bgR:cssVar('--red-bg','#FDEAEA'),bgN:cssVar('--range-bg','#F6F7FB'),
  grid:cssVar('--grid','#d1d5db'), fused:cssVar('--fused','#2563eb'),
  c1:cssVar('--c1','#0ea5e9'),c2:cssVar('--c2','#f97316'),c3:cssVar('--c3','#059669'),c4:cssVar('--c4','#a855f7'),
  c5:cssVar('--c5','#ef4444'),c6:cssVar('--c6','#14b8a6'),c7:cssVar('--c7','#64748b'),c8:cssVar('--c8','#d97706')};

let rows=PRELOADED.rows.slice(); rows.sort((a,b)=>a.Date.localeCompare(b.Date));
let weights = loadWeights() || DEFAULT_W;
let start=0,end=0;
const c=$('#c'); const ctx=c.getContext('2d'); const tip=$('#tip');
const sStart=$('#sStart'), sMid=$('#sMid'), sEnd=$('#sEnd');
const thrGEl=$('#thrG'),thrREl=$('#thrR'); const showBG=$('#showBG'), showFused=$('#showFused'), showFactors=$('#showFactors');
const stateBadge=$('#stateBadge'), rangeLabel=$('#rangeLabel');
const csvUrlEl=$('#csvUrl'), btnSaveSrc=$('#btnSaveSrc'), btnRefresh=$('#btnRefresh'), srcMsg=$('#srcMsg');
const wtTbl=$('#wtTbl tbody'), btnSaveW=$('#btnSaveW'), wtMsg=$('#wtMsg');

// === AMBER/RED: globals & helpers ===
let EVENTS=[];           // 當前視窗內的事件點（供繪圖與 hover）
let STATES=[];           // 每日狀態快取（Green / Range / Red）
let COMP=[], PAD={L:0,R:0,W:0}; // 當前計算結果及畫布邊界資訊

function stateOf(score, g, r){
  if (!isFinite(score)) return 'Rang
